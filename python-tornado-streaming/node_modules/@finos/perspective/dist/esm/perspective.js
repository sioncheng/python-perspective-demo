var L=Object.defineProperty;var j=(r,e)=>{for(var t in e)L(r,t,{get:e[t],enumerable:!0})};var E={};j(E,{COLUMN_SEPARATOR_STRING:()=>J,CONFIG_ALIASES:()=>F,CONFIG_VALID_KEYS:()=>M,DATA_TYPES:()=>q,FILTER_OPERATORS:()=>n,SORT_ORDERS:()=>B,SORT_ORDER_IDS:()=>D,TYPE_AGGREGATES:()=>U,TYPE_FILTERS:()=>K});var q={integer:"integer",float:"float",string:"string",boolean:"boolean",date:"date",datetime:"datetime",object:"object"},F={row_pivot:"group_by","row-pivot":"group_by","row-pivots":"group_by",col_pivot:"split_by",col_pivots:"split_by",column_pivot:"split_by","column-pivot":"split_by","column-pivots":"split_by",filters:"filter",sorts:"sort"},M=["version","viewport","group_by","split_by","aggregates","columns","filter","sort","computed_columns","expressions","group_by_depth","split_by_depth","filter_op"],I=["any","avg","abs sum","count","distinct count","dominant","first by index","last by index","last minus first","last","high","join","low","high minus low","max","mean","median","min","pct sum parent","pct sum grand total","stddev","sum","sum abs","sum not null","unique","var"],k=["any","count","distinct count","distinct leaf","dominant","first by index","join","last by index","last","unique"],z=["any","count","distinct count","distinct leaf","dominant","first by index","last by index","last","unique"],B=["none","asc","desc","col asc","col desc","asc abs","desc abs","col asc abs","col desc abs"],D=[2,0,1,0,1,3,4,3,4],U={string:k,float:I,integer:I,boolean:z,datetime:k,date:k},n={lessThan:"<",greaterThan:">",equals:"==",lessThanOrEquals:"<=",greaterThanOrEquals:">=",doesNotEqual:"!=",isNull:"is null",isNotNull:"is not null",isIn:"in",isNotIn:"not in",contains:"contains",bitwiseAnd:"&",bitwiseOr:"|",and:"and",or:"or",beginsWith:"begins with",endsWith:"ends with"},W=[n.bitwiseAnd,n.bitwiseOr,n.equals,n.doesNotEqual,n.or,n.and,n.isNull,n.isNotNull],R=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull],V=[n.equals,n.contains,n.doesNotEqual,n.isIn,n.isNotIn,n.beginsWith,n.endsWith,n.isNull,n.isNotNull],P=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull],J="|",K={string:V,float:R,integer:R,boolean:W,datetime:P,date:P};var v={types:{float:{filter_operator:"==",aggregate:"sum",format:{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}},string:{filter_operator:"==",aggregate:"count"},integer:{filter_operator:"==",aggregate:"sum",format:{}},boolean:{filter_operator:"==",aggregate:"count"},datetime:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short",timeStyle:"medium"},null_value:-1},date:{filter_operator:"==",aggregate:"count",format:{dateStyle:"short"},null_value:-1}}};function O(r){let e={};if(m().types[r]&&Object.assign(e,m().types[r]),e.type){let t=O(e.type);return Object.assign(t,e),t}else return e}function x(r){return r&&typeof r=="object"&&!Array.isArray(r)}function f(r,...e){if(!e.length)return r;let t=e.shift();if(x(r)&&x(t))for(let o in t)x(t[o])?(r[o]||Object.assign(r,{[o]:{}}),f(r[o],t[o])):Object.assign(r,{[o]:t[o]});return f(r,...e)}function C(r){globalThis.__PERSPECTIVE_CONFIG__&&console.warn("Config already initialized!"),globalThis.__PERSPECTIVE_CONFIG__=f(v,r)}function m(){return globalThis.__PERSPECTIVE_CONFIG__||(globalThis.__PERSPECTIVE_CONFIG__=f(v,globalThis.__TEMPLATE_CONFIG__||{})),globalThis.__PERSPECTIVE_CONFIG__}var T=new WeakMap,N=0;function h(r,e){return function(){let t,o=()=>{},_=Array.prototype.slice.call(arguments,0,arguments.length);for(let u=_.length-1;u>=0;u--)typeof _[u]=="function"&&(t=_.splice(u,1)[0]);let l=T.get(t);T.delete(t);let p={cmd:e||"view_method",name:this._name,method:r,args:_,subscribe:!0,callback_id:l};this._worker.post(p,t,o),this._worker.unsubscribe(e,t)}}function c(r,e){return function(){let t,o=()=>{},_=Array.prototype.slice.call(arguments,0,arguments.length);for(let p=_.length-1;p>=0;p--)typeof _[p]=="function"&&(t=_.splice(p,1)[0]);N++,T.set(t,N);let l={cmd:e||"view_method",name:this._name,method:r,args:_,subscribe:!0,callback_id:N};this._worker.post(l,t,o,!0)}}function i(r,e){return function(){var t=Array.prototype.slice.call(arguments,0,arguments.length);return new Promise(function(o,_){var l={cmd:e||"view_method",name:this._name,method:r,args:t,subscribe:!1};this._worker.post(l,o,_)}.bind(this))}}function s(r,e,t){return new Promise((o,_)=>{this._worker=r,this._name=Math.random()+"",this._worker.post({cmd:"view",view_name:this._name,table_name:e,config:t},()=>{o(this)},_),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&o(this)})}function Y(r,e){this._worker=r,this._name=e}Y.prototype=s.prototype;s.prototype.get_config=i("get_config");s.prototype.get_min_max=i("get_min_max");s.prototype.to_json=i("to_json");s.prototype.to_arrow=i("to_arrow");s.prototype.to_columns=i("to_columns");s.prototype.to_columns_string=i("to_columns_string");s.prototype.to_csv=i("to_csv");s.prototype.schema=i("schema");s.prototype.expression_schema=i("expression_schema");s.prototype.column_paths=i("column_paths");s.prototype.num_columns=i("num_columns");s.prototype.num_rows=i("num_rows");s.prototype.dimensions=i("dimensions");s.prototype.set_depth=i("set_depth");s.prototype.get_row_expanded=i("get_row_expanded");s.prototype.expand=i("expand");s.prototype.collapse=i("collapse");s.prototype.delete=i("delete");s.prototype.col_to_js_typed_array=i("col_to_js_typed_array");s.prototype.on_update=c("on_update","view_method",!0);s.prototype.remove_update=h("remove_update","view_method",!0);s.prototype.on_delete=c("on_delete","view_method",!0);s.prototype.remove_delete=h("remove_delete","view_method",!0);function g(r){let e=r;do for(let t of Object.getOwnPropertyNames(e)){let o=r[t];t!=="constructor"&&typeof o=="function"&&(r[t]=o.bind(r))}while(e=e!==Object&&Object.getPrototypeOf(e))}String.prototype.includes||(String.prototype.includes=function(r,e){return typeof e!="number"&&(e=0),e+r.length>this.length?!1:this.indexOf(r,e)!==-1});Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(r,e){if(this==null)throw new TypeError('"this" is null or not defined');var t=Object(this),o=t.length>>>0;if(o===0)return!1;var _=e|0,l=Math.max(_>=0?_:o-Math.abs(_),0);function p(u,w){return u===w||typeof u=="number"&&typeof w=="number"&&isNaN(u)&&isNaN(w)}for(;l<o;){if(p(t[l],r))return!0;l++}return!1}});function a(r,e,t){return new Promise((o,_)=>{this._worker=r,this._name=t.name||Math.random()+"",g(this),e.to_arrow?(this._worker.post({cmd:"table",name:this._name,args:[],options:t||{}}),e.to_arrow().then(l=>{this._worker.post({cmd:"table",name:this._name,args:[l],options:t||{}},()=>{e.on_update(p=>{this.update(p.delta)},{mode:"row"}),o(this)},_)})):this._worker.post({cmd:"table",name:this._name,args:[e],options:t||{}},()=>{o(this)},_),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&o(this)})}a.prototype.type="table";function A(r,e){this._worker=r,this._name=e}A.prototype=a.prototype;a.prototype.view=function(r){return new s(this._worker,this._name,r)};a.prototype.query_columns=i("query_columns","table_method");a.prototype.get_index=i("get_index","table_method");a.prototype.get_limit=i("get_limit","table_method");a.prototype.get_num_views=i("get_num_views","table_method");a.prototype.make_port=i("make_port","table_method");a.prototype.remove_port=i("remove_port","table_method");a.prototype.schema=i("schema","table_method");a.prototype.validate_expressions=i("validate_expressions","table_method");a.prototype.is_valid_filter=i("is_valid_filter","table_method");a.prototype.size=i("size","table_method");a.prototype.num_rows=i("num_rows","table_method");a.prototype.num_columns=i("num_columns","table_method");a.prototype.columns=i("columns","table_method");a.prototype.clear=i("clear","table_method");a.prototype.replace=i("replace","table_method");a.prototype.delete=i("delete","table_method");a.prototype.on_delete=c("on_delete","table_method",!0);a.prototype.remove=i("remove","table_method");a.prototype.remove_delete=h("remove_delete","table_method",!0);a.prototype.update=function(r,e){return new Promise((t,o)=>{this._worker.post({name:this._name,cmd:"table_method",method:"update",args:[r,e||{}]},t,o,!1)})};a.prototype.execute=function(r){this._worker.post({cmd:"table_execute",name:this._name,f:r.toString()})};var d=class{constructor(){this._initialized=!1,this._worker={initialized:{value:!1},transferable:!1,msg_id:0,handlers:{},messages:[]},g(this)}unsubscribe(e,t){for(let o of Object.keys(this._worker.handlers))this._worker.handlers[o].resolve===t&&delete this._worker.handlers[o]}post(e,t,o,_=!1){++this._worker.msg_id,(t||o)&&(this._worker.handlers[this._worker.msg_id]={resolve:t,reject:o,keep_alive:_}),e.id=this._worker.msg_id,this._worker.initialized.value?this.send(e):this._worker.messages.push(()=>{this.send(e),(e.cmd==="table"||e.cmd==="view")&&!this._features?.wait_for_response&&t&&t()})}async memory_usage(){return await new Promise((e,t)=>{this.post({cmd:"memory_usage"},e,t)})}async get_hosted_table_names(){return await new Promise((e,t)=>{this.post({cmd:"get_hosted_table_names"},e,t)})}initialize_profile_thread(){this._worker.initialized.value?this.send({id:-1,cmd:"init_profile_thread"}):this._worker.messages.push(()=>this.send({id:-1,cmd:"init_profile_thread"}))}send(){throw new Error("send() not implemented")}async open_table(e){return new A(this,e)}_handle(e){if(!this._worker.initialized.value){this._initialized||(this._initialized=!0);let t=this._worker.messages;if(this._worker.initialized.value=!0,this._worker.messages=[],e.data?.data){this._features={};for(let o of e.data.data)this._features[o]=!0}if(t)for(let o in t)t.hasOwnProperty(o)&&t[o]()}if(e.data.id){let t=this._worker.handlers[e.data.id];t&&(e.data.error?t.reject(e.data.error):t.resolve(e.data.data),t.keep_alive||delete this._worker.handlers[e.data.id])}}table(e,t){return new a(this,e,t||{})}terminate(){this._worker.terminate(),this._worker=void 0}};import $ from"ws";var H=3e4,y=class extends d{_ping(){this._ping_loop&&this._ws.send("ping"),this._ping_loop=setTimeout(this._ping.bind(this),H)}_close(){clearTimeout(this._ping_loop),this._ping_loop=void 0,this._on_close_callback?.()}_onmessage(e){if(e.data!=="pong")if(this._pending_binary){let t=e.data;if(this._full_binary.set(new Uint8Array(t),this._total_chunk_length),this._total_chunk_length+=t.byteLength,this._total_chunk_length===this._pending_binary_length)t=this._full_binary.buffer;else return;let o={data:{id:this._pending_binary,data:t}};if(this._pending_port_id!==void 0){let _={port_id:this._pending_port_id,delta:t};o.data.data=_}this._handle(o),delete this._pending_binary,delete this._pending_binary_length,delete this._pending_port_id,this._total_chunk_length=0,this._full_binary=null}else e=JSON.parse(e.data),e.binary_length?(this._pending_binary=e.id,this._pending_binary_length=e.binary_length,e.data&&e.data.port_id!==void 0&&(this._pending_port_id=e.data.port_id),this._full_binary=new Uint8Array(this._pending_binary_length)):this._handle({data:e})}constructor(e){super(),this._ws=e,this._ws.binaryType="arraybuffer",this._full_binary,this._total_chunk_length=0,this._pending_binary_length=0,this._ws.onopen=()=>{this.send({id:-1,cmd:"init"})},this._ping(),this._ws.onclose=this._close.bind(this),this._ws.onmessage=this._onmessage.bind(this)}send(e){if(this._ws.readyState===$.CLOSED){console.warn("Websocket connection is already closed.");return}if(e.args&&e.args.length>0&&e.args[0]instanceof ArrayBuffer&&e.args[0].byteLength!==void 0){let t=e;e.binary_length=e.args[0].byteLength,this._ws.send(JSON.stringify(t)),this._ws.send(e.args[0]);return}this._ws.send(JSON.stringify(e))}terminate(){return new Promise(e=>{this._on_close_callback=e,this._ws.close()})}};import X from"../../src/js/perspective.worker.js";import Z from"../../dist/pkg/web/perspective.cpp.wasm";var G=!1,S=function(){let r;return function(){return r||(r=new class{async worker(){return await X()}async wasm(){let e=await Z;if(e instanceof ArrayBuffer&&!e.buffer&&(e=new Uint8Array(e)),e.buffer&&e.buffer instanceof ArrayBuffer)G=!0,length=e.byteLength,this._wasm=e;else if(e instanceof ArrayBuffer)length=e.byteLength,this._wasm=new Uint8Array(e);else{let t=await fetch(e);this._wasm=await t.arrayBuffer()}return this._wasm}}),r}}(),b=class extends d{constructor(e){e&&C(e),super(),this.register()}async register(){let e,t={cmd:"init",config:m()};if(typeof WebAssembly>"u")throw new Error("WebAssembly not supported.");[e,t.buffer]=await Promise.all([S().worker(),S().wasm()]);for(var o in this._worker)e[o]=this._worker[o];this._worker=e,this._worker.addEventListener("message",this._handle.bind(this)),this._worker.postMessage(t),this._detect_transferable()}send(e){this._worker.transferable&&e.args&&e.args[0]instanceof ArrayBuffer?this._worker.postMessage(e,[e.args[0]]):this._worker.postMessage(e)}terminate(){this._worker.terminate(),this._worker=void 0}get transferable(){return this._worker?.transferable||!1}get inline(){return G}_detect_transferable(){var e=new ArrayBuffer(1);this._worker.postMessage(e,[e]),this._worker.transferable=e.byteLength===0}},Q=function(){let r,e;return{getInstance:function(t){r===void 0&&(r=new b(t));let o=JSON.stringify(t);if(e&&o!==e)throw new Error("Configuration object for shared_worker() has changed - this is probably a bug in your application.");return e=o,r}}}(),Ae=O;function ee(r){return S().set(r)}function te(r){return new b(r)}function re(r=window.location.origin.replace("http","ws")){return new y(new WebSocket(r))}function oe(r){return Q.getInstance(r)}var Se={override:ee,worker:te,websocket:re,shared_worker:oe,...Object.keys(E)};export{Se as default,Ae as get_type_config,ee as override,oe as shared_worker,re as websocket,te as worker};
//# sourceMappingURL=perspective.js.map
